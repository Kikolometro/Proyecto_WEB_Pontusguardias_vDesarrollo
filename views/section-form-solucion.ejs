<!-- FORM -->


<section class="colored-section" id="form">


  <div class="container-fluid" id="contenedor">
    <div class="container-md container_k">
      <div class="progress progress_k">
        <div class="progress-bar progress-bar-striped bg-ptg progress-bar-animated" role="progressbar"
          style="width: 100%" aria-valuenow="<%= topStep %>" aria-valuemin="0" aria-valuemax="<%= topStep %>"></div>
      </div>

      <% if (ind_sol > 0) { %>
      <h3>
        <%= mes %> <%= anyo %>
      </h3>
      <div class="scroll_k" id="scroll_k">
        <table class="table tabla">
          <thead>
            <tr>
              <% for (var i = 0; i < dias_mes + 1 ; i++) { %>
              <% if (i > 0 && festivosArray[i-1]==1) { %>
              <th scope="col" class="table-clear-blue">
                <%= i %>
              </th>
              <% } else if(i > 0) {%>
              <th scope="col">
                <%= i %>
              </th>
              <% } else {%>
              <th scope="col"></th>
              <% }} %>
            </tr>
          </thead>

          <thead>
            <tr>
              <% for (var i = 0; i < dias_mes + 1 ; i++) { %>
              <% if (i > 0 && festivosArray[i-1]==1) { %>
              <th scope="col" class="table-clear-blue">
                <%= weekArray[i-1] %>
              </th>
              <%  } else if (i > 0) { %>
              <th scope="col">
                <%= weekArray[i-1] %>
              </th>
              <% } else {%>
              <th scope="col"></th>
              <% }} %>
            </tr>
          </thead>

          <tbody>
            <% var k = 0%>
            <% for (var i = 0; i < n_resis ; i++) {%>
            <tr>
              <th scope="row" style="padding: 0 5px 0 0; vertical-align: middle;"><%= nombre[i] %> </th>
              <% for (var j = 0; j < dias_mes ; j++) { %>

              <% if (solucion[k] === 1  && guardiasMatrix[i][j] === 1) { %>
              <td class="table-clear-red"><i class="fa-solid fa-house-medical icon-red checkboxSize"></i></td>

              <% } else if (solucion[k] === 0  && vacacionesMatrix[i][j] === 1){%>
              <td class="table-clear-green"> - </td>

              <% } else if (solucion[k] === 0){ %>
              <% if (festivosArray[j]===0) { %>
              <td> - </td>
              <% } else if (festivosArray[j]===1){ %>
              <td class="table-clear-blue"> - </td>
              <% } %>

              <% } else if (solucion[k] === 1){ %>
              <% if (festivosArray[j]===0) { %>
              <td><i class="fa-solid fa-house-medical icon-red checkboxSize "></i></td>
              <% } else if (festivosArray[j]===1){ %>
              <td class="table-clear-blue"><i class="fa-solid fa-house-medical icon-red checkboxSize "></i></td>
              <% } %>

              <%}%>


              <% var k = k + 1%>
              <% } %>
            </tr>
            <% } %>

          </tbody>
        </table>
      </div>

      <div class="container-fluid-light bold">

        <div class="row">

          <div class="col-lg-4">
            <p class="table-clear-blue">Festivos</p>
          </div>

          <div class="col-lg-4">
            <p class="table-clear-red">Guardias preasignadas</p>
          </div>

          <div class="col-lg-4">
            <p class="table-clear-green">Vacaciones asignadas</p>
          </div>

        </div>

      </div>

      <div class="container-text-light">
        <button class="btn btn-ptg-naranja-claro click collapsed pswp__button" type="button" data-toggle="collapse"
          data-target="#collapseExample" aria-expanded="false" aria-controls="collapseExample" onclick="changename()"
          id="collapsedButton">
          <div class="bold" id="collapsedButtontext">Mostrar detalle</div>
          <div class="coll-icon"><i class="arrow up "></i></div>
        </button>

        <div class="collapse" id="collapseExample">
          <div class="card card-body scroll_k">

            <div id="detalle_1">
              <div class="linea_abajo">
                <p class="delimitador ">Médicos de guardia por día</p>
              </div>
              <div class="scroll_k" id="scroll_k">
                <table class="table tabla">
                  <thead>
                    <tr>
                      <% for (var i = 0; i < dias_mes + 1 ; i++) { %>
                      <% if (i > 0 && festivosArray[i-1]==1) { %>
                      <th scope="col" class="table-clear-blue">
                        <%= i %>
                      </th>
                      <% } else if(i > 0) {%>
                      <th scope="col">
                        <%= i %>
                      </th>
                      <% } %>
                      <% }%>
                    </tr>
                  </thead>

                  <thead>
                    <tr>
                      <% for (var i = 0; i < dias_mes + 1 ; i++) { %>
                      <% if (i > 0 && festivosArray[i-1]==1) { %>
                      <th scope="col" class="table-clear-blue">
                        <%= weekArray[i-1] %>
                      </th>
                      <%  } else if (i > 0) { %>
                      <th scope="col">
                        <%= weekArray[i-1] %>
                      </th>
                      <% } %>
                      <% } %>
                    </tr>
                  </thead>

                  <tbody>

                    <tr>                    
                      <% for (var j = 0; j < dias_mes ; j++) { %>
                      <%  if (festivosArray[j]===1){ %>
                      <td class="table-clear-blue"><%=  medicosDeGuardia[j]%> </td>
                      <% } else {%>
                      <td class=""> <%=  medicosDeGuardia[j]%> </td>
                      <% } %>
                      <% } %>
                    </tr>

                  </tbody>
                </table>
              </div>
            </div>

            <br>

            <div id="detalle_2">
              <div class="linea_abajo">
                <p class="delimitador ">Guardias totales</p>
              </div>

              <div class="scroll_k" id="scroll_k">
              <table class="table tabla">

                <thead>
                  <tr>
                    <th scope="col"></th>
                    <th style="vertical-align: middle; padding: 5px;" scope="col">Festivos</th>
                    <th style="vertical-align: middle; padding: 5px;" scope="col">No Festivos</th>
                    <th style="vertical-align: middle; padding: 5px;" scope="col">Total</th>
                  </tr>
                </thead>

                <tbody>
                  <% for (var i = 0; i < n_resis ; i++) {%>
                  <tr>
                    <th scope="row" style="padding: 0 5px 0 0; vertical-align: middle;"><%= nombre[i] %> </th>

                    <td class="table-clear-blue" id="cell_resi_<%= i %>_Fes"> - </td>
                    <td class="" id="cell_resi_<%= i %>_NoFes"> - </td>
                    <td class="table-clear-grey bold" id="cell_resi_<%= i %>_Tot"> - </td>


                  </tr>
                  <% } %>
                  <tr>
                    <th scope="row" style="padding: 0 5px 0 0; vertical-align: middle;"> </th>
                    <td class=""></td>
                    <td class=""></td>

                  </tr>
                </tbody>
              </table>
              </div>
            </div>

            <br>

            <div id="detalle_3">
              <div class="linea_abajo">
                <p class="delimitador ">Guardias por día de la semana</p>
              </div>
              <div class="scroll_k" id="scroll_k">
                <table class="table tabla">

                  <thead>
                    <tr>
                      <th scope="col"></th>
                      <th scope="col">L</th>
                      <th scope="col">M</th>
                      <th scope="col">X</th>
                      <th scope="col">J</th>
                      <th scope="col">V</th>
                      <th scope="col">S</th>
                      <th scope="col">D</th>
                    </tr>
                  </thead>

                  <tbody>

                      <% for (var i = 0; i < n_resis ; i++) {%>
                      <tr>
                        <th scope="row" style="padding: 0 5px 0 0; vertical-align: middle;"><%= nombre[i] %> </th>
                        <% for (var j = 0; j < 7 ; j++) { %>
                        <td class="" id="cell_resi_<%= i %>_dia_<%= j %>"> - </td>
                        <%}%>
                        </tr>
                        
                      <% } %>
                      <tr>
                        <th scope="row" style="padding: 0 5px 0 0; vertical-align: middle;"></th>
                        <% for (var j = 0; j < 7 ; j++) { %>
                        <td class=""> </td>
                        <%}%>
                        
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            

            <br>

            <div id="detalle_4">
              <div class="linea_abajo">
                <p class="delimitador ">Normas y grupos</p>
              </div>

              <div id="formContainer">
                <div class="container-fluid-light">

                  <% for (var i = 0; i < n_resis ; i++) { %>

                    <div class="row">

                      <div class="col-lg-6">
                        <label class="label_form filtro bold" for="Grupo_<%=nombre[i]%>"><%=nombre[i]%>: </label>
                      </div>
                      <div class="col-lg-6">
                        <input class="form-control-equipo filtro" type="text" value="Equipo <%= arrayGroups[i] %>" readonly>
                      </div>

                    </div>
                    <% } %>

            </div>
          </div>

          <div class="guardias-box-clear-green-max col-lg-8 container-fluid" id="cajita_naranja">


            <div id="texto_fin" class="ali_izq ">Estas son las condiciones que has solicitado: <br><br></div>

            <br>

            <div class="container">
              <div class="row">
                <div class="col-xs-12" id='listado_normas'>
                </div>
              </div>
            </div>

          </div>

        </div>


      </div>
    </div>
  </div>

  <% } %>
  <div class="container-text-light">
    <% var arr = [10, 20, 50]%>
    <% if (!arr.includes(cod_error)) { %>
    <div class="recuadro container-text-light">
      <h4> La clave para buscar la solución es: </h4>
      <h3 class="container-text feature-title-box"> <%= idSolBuscada%></h3>
      <div>
        <h5 class="bold">¡Compártela!</h5>
      </div>
      <button class="btn btn-ptg-naranja-margin-top-lateral"
        onclick="copiarEnlacePortapapeles(' <%= idSolBuscada%>')"><i class="fa-solid fa-copy"></i> Copiar
        link</button>
      <a class="btn btn-ptg-naranja-margin-top-lateral "
        href="whatsapp://send?text=Adjunto la planilla de <%= mes%> <%= anyo%>: http://localhost:3000/buscarSolucion?idSol=<%= idSolBuscada%>"
        data-action="share/whatsapp/share" target="_blank">
        <i class="fa-brands fa-whatsapp"></i> Enviar por Whatsapp</a>
      <a class="btn btn-ptg-naranja-margin-top-lateral "
        href="mailto:?subject=Planilla de <%= mes%> <%= anyo%>&body=Adjunto la planilla de <%= mes%> <%= anyo%>: http://localhost:3000/buscarSolucion?idSol=<%= idSolBuscada%>">
        <i class="fa-solid fa-envelope"></i> Enviar por mail </a>
    </div>


    <% } %>
    <% if (cod_error === 0) { %>

    <div class="recuadro">

      <div class="mini-filtro ">
        Por favor, dinos qué te ha parecido la solución:
      </div>

      <div id="feedback-buttons">
        <button id="happy-btn" class="btn happy pswp__button" onclick="updateFeedback(2)"><i
            class="fa-regular fa-face-smile"></i></button>
        <button id="medium-btn" class="btn medium pswp__button" onclick="updateFeedback(1)"><i
            class="fa-regular fa-face-meh-blank"></i></button>
        <button id="sad-btn" class="btn sad pswp__button" onclick="updateFeedback(-1)"><i
            class="fa-regular fa-face-sad-tear"></i></button>

      </div>
    </div>



    <%  } else if (cod_error === 10){ %>
    <div>
      <h4> La clave para buscar la solución es: </h4>
      <h3 class="container-text feature-title-box"> <%= idSolBuscada%></h3>
      <div class="mini-filtro">
        Lo sentimos, algo no ha ido bien al buscar la solución. Puedes probar en unos minutos con el código adjunto.
        Tambien puedes escribirnos a <a href="mailto:info@pontusguardias.com">info@PonTusGuardias.com</a> para que
        busquemos una solución
        alternativa.

        Gracias por confiar en PonTusGuardias.com
      </div>

    </div>


    <%  } else if (cod_error === 20){ %>
    <div class="mini-filtro">
      Lo sentimos, no hemos encontrado una solución para la planilla que planteas. 
      <br><br>
      <strong>Puedes hacer cambios en la solicitud haciendo click en "Reutilizar planilla" </strong> o puedes escribirnos a <a
        href="mailto:info@pontusguardias.com">info@PonTusGuardias.com</a> para que busquemos una solución
      alternativa.
      <br><br>
      <color-orange>Gracias por confiar en PonTusGuardias.com</color-orange> 
    </div>
  <br>
    <div class="recuadro container-text-light">
      <h4> Apúntate la clave para recuperar la solicitud más adelante: </h4>
      <h3 class="container-text feature-title-box"> <%= idSolBuscada%></h3>
      
    </div>

    <%  } else if (cod_error === 30){ %>
    <div>

      <div class="mini-filtro">
        Lo sentimos, se ha agotado el tiempo de búsqueda. Puedes probar en unos minutos con el código adjunto.
        Tambien
        puedes escribirnos a <a href="mailto:info@pontusguardias.com">info@PonTusGuardias.com</a> para que busquemos
        una solución
        alternativa.

        Gracias por confiar en PonTusGuardias.com
      </div>
    </div>

    <%  } else if (cod_error === 50){ %>
    <div>
      <div class="mini-filtro">
        Lo sentimos, <strong>esa clave no existe</strong>. Prueba a escribirnos a <a
          href="mailto:info@pontusguardias.com">info@PonTusGuardias.com</a> para ayudarte a encontrar tu planilla.

        Gracias por confiar en PonTusGuardias.com
      </div>
    </div>


    <%  } %>



    <div class="container-fluid-light bold">

      <div class="row justify-content-md-center">
        <% arr = [10, 50]%>
        <% if (!arr.includes(cod_error)) { %>
        <div class="col-lg-4">

          <form action="/reutilizar-planilla#form" method="POST">
            <div class="form-group">
              <input type="hidden" name="step" value="1">
            </div>
            <button class="btn btn-ptg bold" type="submit">Reutilizar planilla</button>
          </form>

          <div class="col-md-auto">

          </div>

        </div>
        <% } %>
        <div class="col-lg-4">

          <form action="/" method="POST">
            <div class="form-group">
              <input type="hidden" name="step" value="0">
            </div>

            <button class="btn btn-ptg bold" type="submit">Volver a empezar</button>
          </form>

        </div>
      </div>
    </div>

  </div>


  </div>
  </div>
</section>

<script type="text/javascript">
  var elms_blue = document.getElementsByClassName("table-clear-blue");
  var n_blue = elms_blue.length;
  var n = 0;

  function changeColor(color) {
    for (var i = 0; i < n; i++) {
      elms[i].style.backgroundColor = color;
    }
  }
  for (var i = 0; i < n_blue; i++) {

    elms_blue[i].onmouseover = function () {
      elms = elms_blue
      n = n_blue
      changeColor("#86def7");
    };
    elms_blue[i].onmouseout = function () {
      elms = elms_blue
      changeColor("#bdeaf7");
    };
  }

  var elms_red = document.getElementsByClassName("table-clear-red");
  var n_red = elms_red.length;

  for (var i = 0; i < n_red; i++) {
    elms_red[i].onmouseover = function () {
      elms = elms_red
      n = n_red
      changeColor("#fa6464");
    };
    elms_red[i].onmouseout = function () {
      elms = elms_red
      changeColor("#f7cfbd");
    };
  }

  var elms_green = document.getElementsByClassName("table-clear-green");
  var n_green = elms_green.length;

  for (var i = 0; i < n_green; i++) {
    elms_green[i].onmouseover = function () {
      elms = elms_green
      n = n_green
      changeColor("#b5f385");
    };
    elms_green[i].onmouseout = function () {
      elms = elms_green
      changeColor("#d6f7bd");
    };
  }

  $(document).ready(function () {
    $(document).scrollTop($("#form").offset().top);
  });

  let cod_error = '<%= cod_error %>';
  
  if (cod_error == 0 || cod_error == 20) {
    actualizarNormas()
    actualizarGuardias()
  }

  function actualizarGuardias() {
    let n_resis = '<%= n_resis %>'
    let dias_mes = '<%= dias_mes%>'
    dias_mes = parseInt(dias_mes)
    let solucion_v = '<%= solucion %>'
    let festivosArray_v = '<%= festivosArray%>'
    let weekArray_v = '<%= weekArray%>'



    let solucion_split = solucion_v.split(",")
    let festivosArray_v_split = festivosArray_v.split(",")
    let weekArray_v_split = weekArray_v.split(",")

    var solucion_split_num = solucion_split.map(function (x) {
      return parseInt(x, 10);
    });

    const chunkSize = dias_mes;
    const chunks = [];
    for (let i = 0; i < solucion_split_num.length; i += chunkSize) {
      const chunk = solucion_split_num.slice(i, i + chunkSize);
      chunks.push(chunk);
    }
    console.log(chunks)

    // Festivos del mes
    for (let i = 0; i < n_resis; i++) {

      let id_Fes_nom = "cell_resi_" + i + "_Fes"
      let id_NoFes_nom = "cell_resi_" + i + "_NoFes"
      let id_Tot_nom = "cell_resi_" + i + "_Tot"

      let id_Fes = document.getElementById(id_Fes_nom)
      let id_NoFes = document.getElementById(id_NoFes_nom)
      let id_Tot = document.getElementById(id_Tot_nom)

      let total = 0
      let festivos = 0
      let Nofestivos = 0

      for (let j = 0; j < dias_mes; j++) {
        total += chunks[i][j]

        if (festivosArray_v_split[j] == '1') {
          festivos += chunks[i][j]
        } else Nofestivos += chunks[i][j]

      }

      id_Fes.innerText = festivos
      id_NoFes.innerText = Nofestivos
      id_Tot.innerText = total
    }

    // Dias de la semana
    for (let i = 0; i < n_resis; i++) {
      for (let j = 0; j < 7; j++) {

        let id_resi_dia_nom = "cell_resi_" + i + "_dia_" + j
        let id_resi_dia = document.getElementById(id_resi_dia_nom)
        let dia = 'A'

        if (j === 0) {
          dia = 'L'
        } else if (j === 1) {
          dia = 'M'
        } else if (j === 2) {
          dia = 'X'
        } else if (j === 3) {
          dia = 'J'
        } else if (j === 4) {
          dia = 'V'
        } else if (j === 5) {
          dia = 'S'
        } else if (j === 6) {
          dia = 'D'
        }

        let tot_dia = 0;
        for (let k = 0; k < dias_mes; k++) {
          if (weekArray_v_split[k] === dia) {
            tot_dia += chunks[i][k]
          }
        }

        id_resi_dia.innerText = tot_dia;
      }
    }

  }

  function changename() {
    let collapsedButton = document.getElementById("collapsedButton")
    let collapsedButtontext = document.getElementById("collapsedButtontext")

    if (collapsedButton.getAttribute('aria-expanded') === 'true') {
      collapsedButtontext.innerHTML = "Mostrar detalle"

    } else if (collapsedButton.getAttribute('aria-expanded') === 'false') {
      collapsedButtontext.innerHTML = "Ocultar detalle"

    }
  }

  function copiarEnlacePortapapeles(idsolucion) {
    // Get the text field
    var idSolu = idsolucion;
    //var copyText = "https://PonTusGuardias.com//buscarSolucion?idSol="+ idSolBuscada;
    //    var copyText = "http://localhost:3000/buscarSolucion?idSol=" + idSolu;
    var copyText = "http://localhost:3000/buscarSolucion?idSol=" + idSolu;
    copyText = copyText.split(" ").join("");

    // Copy the text inside the text field
    navigator.clipboard.writeText(copyText);

    // Alert the copied text
    alert("¡Enlace copiado! Ahora compártelo");
  }

  function updateFeedback(status) {
    // Make a POST request to your server with the updated status
    fetch('/update-feedback', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          clientStatus: status
        })
      })
      .then(response => {
        // Handle the response from the server if needed
      })
      .catch(error => {
        console.error('Error:', error);
      });
  }

  function reutilizarPlanilla() {

    // Make a POST request to your server with the updated status
    fetch('/reutilizar-planilla', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          clientStatus: status
        })
      })
      .then(response => {
        // Handle the response from the server if needed
      })
      .catch(error => {
        console.error('Error:', error);
      });
  }

  function actualizarNormas() {

    let arrayNormas_pre = '<%= arrayNormas %>';
    let arrayNormas = arrayNormas_pre.split(',');

    //document.getElementById("arrayNormas").value = arrayNormas
    let bucle = arrayNormas.length
    let array_pos_0 = arrayNormas[0]
    //console.log(arrayNormas)

    var listado_normas = document.getElementById('listado_normas')
    var texto_fin = document.getElementById('texto_fin')
    if (array_pos_0== "") {
      texto_fin.innerHTML =
        "<b>No has establecido ninguna condición. </b>"
    } else {

      //texto_fin.innerHTML = "Estas son las normas que has solicitado: <br><br><b> En la misma guardia...</b>"
      texto_fin.innerHTML = "<b>Estas son las normas que has solicitado: </b><br>"


      while (listado_normas.hasChildNodes()) {
        listado_normas.removeChild(listado_normas.firstChild)
      }

      for (let i = 0; i < bucle; i++) {
        // Create a new item
        var newItem = document.createElement('div');
        newItem.setAttribute('class', 'item list-group-item');


        var newItemLeft = document.createElement('div');
        newItemLeft.setAttribute('class', 'titulin');
        newItemLeft.classList.add('item-left');



        let arrayNormas_split = arrayNormas[i].split('_')
        //console.log(arrayNormas_split)
        switch (arrayNormas_split[0]) {
          case '1':
            newItemLeft.innerHTML = 'En la misma guardia: si hay alguien del Equipo ' + arrayNormas_split[1] +
              ', se forzará que siempre haya alguien del Equipo ' + arrayNormas_split[2] + ', pero no al revés'
            break;

          case '2':
            newItemLeft.innerHTML = 'En la misma guardia: si hay algún médico del Equipo ' + arrayNormas_split[1] +
              ', nunca coincidirá con nadie del Equipo ' + arrayNormas_split[2] + ' y viceversa'
            break;

          case '3':
            newItemLeft.innerHTML = 'En la misma guardia: siempre habrá algún médico del Equipo ' + arrayNormas_split[
              1]
            break;

          case '4':
            if (arrayNormas_split[1] == "1") {
              newItemLeft.innerHTML = 'En la misma guardia: nunca coincidirá más de ' + arrayNormas_split[1] +
                ' médico del Equipo ' +
                arrayNormas_split[2]
            } else {
              newItemLeft.innerHTML = 'En la misma guardia: nunca coincidirán más de ' + arrayNormas_split[1] +
                ' médicos del Equipo ' +
                arrayNormas_split[2]
            }
            break;

          case '5':
            newItemLeft.innerHTML = 'En la misma guardia: si hay alguien del Equipo ' + arrayNormas_split[1] +
              ', se forzará que siempre haya alguien del Equipo ' + arrayNormas_split[2] + ', y viceversa'
            break;
          case '6':
            let dia = "";
            switch (arrayNormas_split[2]) {
              case 'L':
                dia = 'lunes'
                break;
              case 'M':
                dia = 'martes'
                break;
              case 'X':
                dia = 'miércoles'
                break;
              case 'J':
                dia = 'jueves'
                break;
              case 'V':
                dia = 'viernes'
                break;
              case 'S':
                dia = 'sábado'
                break;
              case 'D':
                dia = 'domingo'
                break;
              default:
                dia = "";
            }
            newItemLeft.innerHTML = 'Nadie hará más de ' + arrayNormas_split[1] +
              ' guardia/s en ' + dia
            break;
          case '7':
            if (arrayNormas_split[1] == "T") {
              newItemLeft.innerHTML =
                'Las guardias en fin de semana de todos los equipos serán dobletes (viernes y domingo), sólo sábados o sin guardias'
            } else {
              newItemLeft.innerHTML = 'Las guardias en fin de semana del equipo ' + arrayNormas_split[1] +
                ' serán dobletes (viernes y domingo), sólo sábados, o sin guardias'
            }

            break;
          default:
            //console.log('Ha habido un error');
        }


        newItem.appendChild(newItemLeft);

        // Add the new item to the item list

        listado_normas.appendChild(newItem)
      }
    }
  };
</script>